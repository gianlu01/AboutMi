{"ast":null,"code":"var Constants = require('./constants');\n\nmodule.exports = function render() {\n  var store = this;\n  var mapExists = store.ctx.map && store.ctx.map.getSource(Constants.sources.HOT) !== undefined;\n  if (!mapExists) return cleanup();\n  var mode = store.ctx.events.currentModeName();\n  store.ctx.ui.queueMapClasses({\n    mode: mode\n  });\n  var newHotIds = [];\n  var newColdIds = [];\n\n  if (store.isDirty) {\n    newColdIds = store.getAllIds();\n  } else {\n    newHotIds = store.getChangedIds().filter(function (id) {\n      return store.get(id) !== undefined;\n    });\n    newColdIds = store.sources.hot.filter(function (geojson) {\n      return geojson.properties.id && newHotIds.indexOf(geojson.properties.id) === -1 && store.get(geojson.properties.id) !== undefined;\n    }).map(function (geojson) {\n      return geojson.properties.id;\n    });\n  }\n\n  store.sources.hot = [];\n  var lastColdCount = store.sources.cold.length;\n  store.sources.cold = store.isDirty ? [] : store.sources.cold.filter(function (geojson) {\n    var id = geojson.properties.id || geojson.properties.parent;\n    return newHotIds.indexOf(id) === -1;\n  });\n  var coldChanged = lastColdCount !== store.sources.cold.length || newColdIds.length > 0;\n  newHotIds.forEach(function (id) {\n    return renderFeature(id, 'hot');\n  });\n  newColdIds.forEach(function (id) {\n    return renderFeature(id, 'cold');\n  });\n\n  function renderFeature(id, source) {\n    var feature = store.get(id);\n    var featureInternal = feature.internal(mode);\n    store.ctx.events.currentModeRender(featureInternal, function (geojson) {\n      store.sources[source].push(geojson);\n    });\n  }\n\n  if (coldChanged) {\n    store.ctx.map.getSource(Constants.sources.COLD).setData({\n      type: Constants.geojsonTypes.FEATURE_COLLECTION,\n      features: store.sources.cold\n    });\n  }\n\n  store.ctx.map.getSource(Constants.sources.HOT).setData({\n    type: Constants.geojsonTypes.FEATURE_COLLECTION,\n    features: store.sources.hot\n  });\n\n  if (store._emitSelectionChange) {\n    store.ctx.map.fire(Constants.events.SELECTION_CHANGE, {\n      features: store.getSelected().map(function (feature) {\n        return feature.toGeoJSON();\n      }),\n      points: store.getSelectedCoordinates().map(function (coordinate) {\n        return {\n          type: Constants.geojsonTypes.FEATURE,\n          properties: {},\n          geometry: {\n            type: Constants.geojsonTypes.POINT,\n            coordinates: coordinate.coordinates\n          }\n        };\n      })\n    });\n    store._emitSelectionChange = false;\n  }\n\n  if (store._deletedFeaturesToEmit.length) {\n    var geojsonToEmit = store._deletedFeaturesToEmit.map(function (feature) {\n      return feature.toGeoJSON();\n    });\n\n    store._deletedFeaturesToEmit = [];\n    store.ctx.map.fire(Constants.events.DELETE, {\n      features: geojsonToEmit\n    });\n  }\n\n  cleanup();\n  store.ctx.map.fire(Constants.events.RENDER, {});\n\n  function cleanup() {\n    store.isDirty = false;\n    store.clearChangedIds();\n  }\n};","map":null,"metadata":{},"sourceType":"script"}