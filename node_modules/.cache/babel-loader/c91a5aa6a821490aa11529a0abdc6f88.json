{"ast":null,"code":"var setupModeHandler = require('./lib/mode_handler');\n\nvar getFeaturesAndSetCursor = require('./lib/get_features_and_set_cursor');\n\nvar featuresAt = require('./lib/features_at');\n\nvar isClick = require('./lib/is_click');\n\nvar isTap = require('./lib/is_tap');\n\nvar Constants = require('./constants');\n\nvar objectToMode = require('./modes/object_to_mode');\n\nmodule.exports = function (ctx) {\n  var modes = Object.keys(ctx.options.modes).reduce(function (m, k) {\n    m[k] = objectToMode(ctx.options.modes[k]);\n    return m;\n  }, {});\n  var mouseDownInfo = {};\n  var touchStartInfo = {};\n  var events = {};\n  var _currentModeName = null;\n  var currentMode = null;\n\n  events.drag = function (event, isDrag) {\n    if (isDrag({\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      ctx.ui.queueMapClasses({\n        mouse: Constants.cursors.DRAG\n      });\n      currentMode.drag(event);\n    } else {\n      event.originalEvent.stopPropagation();\n    }\n  };\n\n  events.mousedrag = function (event) {\n    events.drag(event, function (endInfo) {\n      return !isClick(mouseDownInfo, endInfo);\n    });\n  };\n\n  events.touchdrag = function (event) {\n    events.drag(event, function (endInfo) {\n      return !isTap(touchStartInfo, endInfo);\n    });\n  };\n\n  events.mousemove = function (event) {\n    var button = event.originalEvent.buttons !== undefined ? event.originalEvent.buttons : event.originalEvent.which;\n\n    if (button === 1) {\n      return events.mousedrag(event);\n    }\n\n    var target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousemove(event);\n  };\n\n  events.mousedown = function (event) {\n    mouseDownInfo = {\n      time: new Date().getTime(),\n      point: event.point\n    };\n    var target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousedown(event);\n  };\n\n  events.mouseup = function (event) {\n    var target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n\n    if (isClick(mouseDownInfo, {\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      currentMode.click(event);\n    } else {\n      currentMode.mouseup(event);\n    }\n  };\n\n  events.mouseout = function (event) {\n    currentMode.mouseout(event);\n  };\n\n  events.touchstart = function (event) {\n    // Prevent emulated mouse events because we will fully handle the touch here.\n    // This does not stop the touch events from propogating to mapbox though.\n    event.originalEvent.preventDefault();\n\n    if (!ctx.options.touchEnabled) {\n      return;\n    }\n\n    touchStartInfo = {\n      time: new Date().getTime(),\n      point: event.point\n    };\n    var target = featuresAt.touch(event, null, ctx)[0];\n    event.featureTarget = target;\n    currentMode.touchstart(event);\n  };\n\n  events.touchmove = function (event) {\n    event.originalEvent.preventDefault();\n\n    if (!ctx.options.touchEnabled) {\n      return;\n    }\n\n    currentMode.touchmove(event);\n    return events.touchdrag(event);\n  };\n\n  events.touchend = function (event) {\n    event.originalEvent.preventDefault();\n\n    if (!ctx.options.touchEnabled) {\n      return;\n    }\n\n    var target = featuresAt.touch(event, null, ctx)[0];\n    event.featureTarget = target;\n\n    if (isTap(touchStartInfo, {\n      time: new Date().getTime(),\n      point: event.point\n    })) {\n      currentMode.tap(event);\n    } else {\n      currentMode.touchend(event);\n    }\n  }; // 8 - Backspace\n  // 46 - Delete\n\n\n  var isKeyModeValid = function isKeyModeValid(code) {\n    return !(code === 8 || code === 46 || code >= 48 && code <= 57);\n  };\n\n  events.keydown = function (event) {\n    if ((event.srcElement || event.target).classList[0] !== 'mapboxgl-canvas') return; // we only handle events on the map\n\n    if ((event.keyCode === 8 || event.keyCode === 46) && ctx.options.controls.trash) {\n      event.preventDefault();\n      currentMode.trash();\n    } else if (isKeyModeValid(event.keyCode)) {\n      currentMode.keydown(event);\n    } else if (event.keyCode === 49 && ctx.options.controls.point) {\n      changeMode(Constants.modes.DRAW_POINT);\n    } else if (event.keyCode === 50 && ctx.options.controls.line_string) {\n      changeMode(Constants.modes.DRAW_LINE_STRING);\n    } else if (event.keyCode === 51 && ctx.options.controls.polygon) {\n      changeMode(Constants.modes.DRAW_POLYGON);\n    }\n  };\n\n  events.keyup = function (event) {\n    if (isKeyModeValid(event.keyCode)) {\n      currentMode.keyup(event);\n    }\n  };\n\n  events.zoomend = function () {\n    ctx.store.changeZoom();\n  };\n\n  events.data = function (event) {\n    if (event.dataType === 'style') {\n      var setup = ctx.setup,\n          map = ctx.map,\n          options = ctx.options,\n          store = ctx.store;\n      var hasLayers = options.styles.some(function (style) {\n        return map.getLayer(style.id);\n      });\n\n      if (!hasLayers) {\n        setup.addLayers();\n        store.setDirty();\n        store.render();\n      }\n    }\n  };\n\n  function changeMode(modename, nextModeOptions) {\n    var eventOptions = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n    currentMode.stop();\n    var modebuilder = modes[modename];\n\n    if (modebuilder === undefined) {\n      throw new Error(\"\".concat(modename, \" is not valid\"));\n    }\n\n    _currentModeName = modename;\n    var mode = modebuilder(ctx, nextModeOptions);\n    currentMode = setupModeHandler(mode, ctx);\n\n    if (!eventOptions.silent) {\n      ctx.map.fire(Constants.events.MODE_CHANGE, {\n        mode: modename\n      });\n    }\n\n    ctx.store.setDirty();\n    ctx.store.render();\n  }\n\n  var actionState = {\n    trash: false,\n    combineFeatures: false,\n    uncombineFeatures: false\n  };\n\n  function actionable(actions) {\n    var changed = false;\n    Object.keys(actions).forEach(function (action) {\n      if (actionState[action] === undefined) throw new Error('Invalid action type');\n      if (actionState[action] !== actions[action]) changed = true;\n      actionState[action] = actions[action];\n    });\n    if (changed) ctx.map.fire(Constants.events.ACTIONABLE, {\n      actions: actionState\n    });\n  }\n\n  var api = {\n    start: function start() {\n      _currentModeName = ctx.options.defaultMode;\n      currentMode = setupModeHandler(modes[_currentModeName](ctx), ctx);\n    },\n    changeMode: changeMode,\n    actionable: actionable,\n    currentModeName: function currentModeName() {\n      return _currentModeName;\n    },\n    currentModeRender: function currentModeRender(geojson, push) {\n      return currentMode.render(geojson, push);\n    },\n    fire: function fire(name, event) {\n      if (events[name]) {\n        events[name](event);\n      }\n    },\n    addEventListeners: function addEventListeners() {\n      ctx.map.on('mousemove', events.mousemove);\n      ctx.map.on('mousedown', events.mousedown);\n      ctx.map.on('mouseup', events.mouseup);\n      ctx.map.on('data', events.data);\n      ctx.map.on('touchmove', events.touchmove);\n      ctx.map.on('touchstart', events.touchstart);\n      ctx.map.on('touchend', events.touchend);\n      ctx.container.addEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.addEventListener('keydown', events.keydown);\n        ctx.container.addEventListener('keyup', events.keyup);\n      }\n    },\n    removeEventListeners: function removeEventListeners() {\n      ctx.map.off('mousemove', events.mousemove);\n      ctx.map.off('mousedown', events.mousedown);\n      ctx.map.off('mouseup', events.mouseup);\n      ctx.map.off('data', events.data);\n      ctx.map.off('touchmove', events.touchmove);\n      ctx.map.off('touchstart', events.touchstart);\n      ctx.map.off('touchend', events.touchend);\n      ctx.container.removeEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.removeEventListener('keydown', events.keydown);\n        ctx.container.removeEventListener('keyup', events.keyup);\n      }\n    },\n    trash: function trash(options) {\n      currentMode.trash(options);\n    },\n    combineFeatures: function combineFeatures() {\n      currentMode.combineFeatures();\n    },\n    uncombineFeatures: function uncombineFeatures() {\n      currentMode.uncombineFeatures();\n    },\n    getMode: function getMode() {\n      return _currentModeName;\n    }\n  };\n  return api;\n};","map":{"version":3,"sources":["C:/Users/michele/Desktop/IT/Code/react/aboutmi/node_modules/@mapbox/mapbox-gl-draw/src/events.js"],"names":["setupModeHandler","require","getFeaturesAndSetCursor","featuresAt","isClick","isTap","Constants","objectToMode","module","exports","ctx","modes","Object","keys","options","reduce","m","k","mouseDownInfo","touchStartInfo","events","currentModeName","currentMode","drag","event","isDrag","point","time","Date","getTime","ui","queueMapClasses","mouse","cursors","DRAG","originalEvent","stopPropagation","mousedrag","endInfo","touchdrag","mousemove","button","buttons","undefined","which","target","featureTarget","mousedown","mouseup","click","mouseout","touchstart","preventDefault","touchEnabled","touch","touchmove","touchend","tap","isKeyModeValid","code","keydown","srcElement","classList","keyCode","controls","trash","changeMode","DRAW_POINT","line_string","DRAW_LINE_STRING","polygon","DRAW_POLYGON","keyup","zoomend","store","changeZoom","data","dataType","setup","map","hasLayers","styles","some","style","getLayer","id","addLayers","setDirty","render","modename","nextModeOptions","eventOptions","stop","modebuilder","Error","mode","silent","fire","MODE_CHANGE","actionState","combineFeatures","uncombineFeatures","actionable","actions","changed","forEach","action","ACTIONABLE","api","start","defaultMode","currentModeRender","geojson","push","name","addEventListeners","on","container","addEventListener","keybindings","removeEventListeners","off","removeEventListener","getMode"],"mappings":"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","sourcesContent":["const setupModeHandler = require('./lib/mode_handler');\r\nconst getFeaturesAndSetCursor = require('./lib/get_features_and_set_cursor');\r\nconst featuresAt = require('./lib/features_at');\r\nconst isClick = require('./lib/is_click');\r\nconst isTap = require('./lib/is_tap');\r\nconst Constants = require('./constants');\r\nconst objectToMode = require('./modes/object_to_mode');\r\n\r\nmodule.exports = function(ctx) {\r\n\r\n  const modes = Object.keys(ctx.options.modes).reduce((m, k) => {\r\n    m[k] = objectToMode(ctx.options.modes[k]);\r\n    return m;\r\n  }, {});\r\n\r\n  let mouseDownInfo = {};\r\n  let touchStartInfo = {};\r\n  const events = {};\r\n  let currentModeName = null;\r\n  let currentMode = null;\r\n\r\n  events.drag = function(event, isDrag) {\r\n    if (isDrag({\r\n      point: event.point,\r\n      time: new Date().getTime()\r\n    })) {\r\n      ctx.ui.queueMapClasses({ mouse: Constants.cursors.DRAG });\r\n      currentMode.drag(event);\r\n    } else {\r\n      event.originalEvent.stopPropagation();\r\n    }\r\n  };\r\n\r\n  events.mousedrag = function(event) {\r\n    events.drag(event, (endInfo) => !isClick(mouseDownInfo, endInfo));\r\n  };\r\n\r\n  events.touchdrag = function(event) {\r\n    events.drag(event, (endInfo) => !isTap(touchStartInfo, endInfo));\r\n  };\r\n\r\n  events.mousemove = function(event) {\r\n    const button = event.originalEvent.buttons !== undefined ? event.originalEvent.buttons : event.originalEvent.which;\r\n    if (button === 1) {\r\n      return events.mousedrag(event);\r\n    }\r\n    const target = getFeaturesAndSetCursor(event, ctx);\r\n    event.featureTarget = target;\r\n    currentMode.mousemove(event);\r\n  };\r\n\r\n  events.mousedown = function(event) {\r\n    mouseDownInfo = {\r\n      time: new Date().getTime(),\r\n      point: event.point\r\n    };\r\n    const target = getFeaturesAndSetCursor(event, ctx);\r\n    event.featureTarget = target;\r\n    currentMode.mousedown(event);\r\n  };\r\n\r\n  events.mouseup = function(event) {\r\n    const target = getFeaturesAndSetCursor(event, ctx);\r\n    event.featureTarget = target;\r\n\r\n    if (isClick(mouseDownInfo, {\r\n      point: event.point,\r\n      time: new Date().getTime()\r\n    })) {\r\n      currentMode.click(event);\r\n    } else {\r\n      currentMode.mouseup(event);\r\n    }\r\n  };\r\n\r\n  events.mouseout = function(event) {\r\n    currentMode.mouseout(event);\r\n  };\r\n\r\n  events.touchstart = function(event) {\r\n    // Prevent emulated mouse events because we will fully handle the touch here.\r\n    // This does not stop the touch events from propogating to mapbox though.\r\n    event.originalEvent.preventDefault();\r\n    if (!ctx.options.touchEnabled) {\r\n      return;\r\n    }\r\n\r\n    touchStartInfo = {\r\n      time: new Date().getTime(),\r\n      point: event.point\r\n    };\r\n    const target = featuresAt.touch(event, null, ctx)[0];\r\n    event.featureTarget = target;\r\n    currentMode.touchstart(event);\r\n  };\r\n\r\n  events.touchmove = function(event) {\r\n    event.originalEvent.preventDefault();\r\n    if (!ctx.options.touchEnabled) {\r\n      return;\r\n    }\r\n\r\n    currentMode.touchmove(event);\r\n    return events.touchdrag(event);\r\n  };\r\n\r\n  events.touchend = function(event) {\r\n    event.originalEvent.preventDefault();\r\n    if (!ctx.options.touchEnabled) {\r\n      return;\r\n    }\r\n\r\n    const target = featuresAt.touch(event, null, ctx)[0];\r\n    event.featureTarget = target;\r\n    if (isTap(touchStartInfo, {\r\n      time: new Date().getTime(),\r\n      point: event.point\r\n    })) {\r\n      currentMode.tap(event);\r\n    } else {\r\n      currentMode.touchend(event);\r\n    }\r\n  };\r\n\r\n  // 8 - Backspace\r\n  // 46 - Delete\r\n  const isKeyModeValid = (code) => !(code === 8 || code === 46 || (code >= 48 && code <= 57));\r\n\r\n  events.keydown = function(event) {\r\n    if ((event.srcElement || event.target).classList[0] !== 'mapboxgl-canvas') return; // we only handle events on the map\r\n\r\n    if ((event.keyCode === 8 || event.keyCode === 46) && ctx.options.controls.trash) {\r\n      event.preventDefault();\r\n      currentMode.trash();\r\n    } else if (isKeyModeValid(event.keyCode)) {\r\n      currentMode.keydown(event);\r\n    } else if (event.keyCode === 49 && ctx.options.controls.point) {\r\n      changeMode(Constants.modes.DRAW_POINT);\r\n    } else if (event.keyCode === 50 && ctx.options.controls.line_string) {\r\n      changeMode(Constants.modes.DRAW_LINE_STRING);\r\n    } else if (event.keyCode === 51 && ctx.options.controls.polygon) {\r\n      changeMode(Constants.modes.DRAW_POLYGON);\r\n    }\r\n  };\r\n\r\n  events.keyup = function(event) {\r\n    if (isKeyModeValid(event.keyCode)) {\r\n      currentMode.keyup(event);\r\n    }\r\n  };\r\n\r\n  events.zoomend = function() {\r\n    ctx.store.changeZoom();\r\n  };\r\n\r\n  events.data = function(event) {\r\n    if (event.dataType === 'style') {\r\n      const { setup, map, options, store } = ctx;\r\n      const hasLayers = options.styles.some(style => map.getLayer(style.id));\r\n      if (!hasLayers) {\r\n        setup.addLayers();\r\n        store.setDirty();\r\n        store.render();\r\n      }\r\n    }\r\n  };\r\n\r\n  function changeMode(modename, nextModeOptions, eventOptions = {}) {\r\n    currentMode.stop();\r\n\r\n    const modebuilder = modes[modename];\r\n    if (modebuilder === undefined) {\r\n      throw new Error(`${modename} is not valid`);\r\n    }\r\n    currentModeName = modename;\r\n    const mode = modebuilder(ctx, nextModeOptions);\r\n    currentMode = setupModeHandler(mode, ctx);\r\n\r\n    if (!eventOptions.silent) {\r\n      ctx.map.fire(Constants.events.MODE_CHANGE, { mode: modename});\r\n    }\r\n\r\n    ctx.store.setDirty();\r\n    ctx.store.render();\r\n  }\r\n\r\n  const actionState = {\r\n    trash: false,\r\n    combineFeatures: false,\r\n    uncombineFeatures: false\r\n  };\r\n\r\n  function actionable(actions) {\r\n    let changed = false;\r\n    Object.keys(actions).forEach(action => {\r\n      if (actionState[action] === undefined) throw new Error('Invalid action type');\r\n      if (actionState[action] !== actions[action]) changed = true;\r\n      actionState[action] = actions[action];\r\n    });\r\n    if (changed) ctx.map.fire(Constants.events.ACTIONABLE, { actions: actionState });\r\n  }\r\n\r\n  const api = {\r\n    start: function() {\r\n      currentModeName = ctx.options.defaultMode;\r\n      currentMode = setupModeHandler(modes[currentModeName](ctx), ctx);\r\n    },\r\n    changeMode,\r\n    actionable,\r\n    currentModeName: function() {\r\n      return currentModeName;\r\n    },\r\n    currentModeRender: function(geojson, push) {\r\n      return currentMode.render(geojson, push);\r\n    },\r\n    fire: function(name, event) {\r\n      if (events[name]) {\r\n        events[name](event);\r\n      }\r\n    },\r\n    addEventListeners: function() {\r\n      ctx.map.on('mousemove', events.mousemove);\r\n      ctx.map.on('mousedown', events.mousedown);\r\n      ctx.map.on('mouseup', events.mouseup);\r\n      ctx.map.on('data', events.data);\r\n\r\n      ctx.map.on('touchmove', events.touchmove);\r\n      ctx.map.on('touchstart', events.touchstart);\r\n      ctx.map.on('touchend', events.touchend);\r\n\r\n      ctx.container.addEventListener('mouseout', events.mouseout);\r\n\r\n      if (ctx.options.keybindings) {\r\n        ctx.container.addEventListener('keydown', events.keydown);\r\n        ctx.container.addEventListener('keyup', events.keyup);\r\n      }\r\n    },\r\n    removeEventListeners: function() {\r\n      ctx.map.off('mousemove', events.mousemove);\r\n      ctx.map.off('mousedown', events.mousedown);\r\n      ctx.map.off('mouseup', events.mouseup);\r\n      ctx.map.off('data', events.data);\r\n\r\n      ctx.map.off('touchmove', events.touchmove);\r\n      ctx.map.off('touchstart', events.touchstart);\r\n      ctx.map.off('touchend', events.touchend);\r\n\r\n      ctx.container.removeEventListener('mouseout', events.mouseout);\r\n\r\n      if (ctx.options.keybindings) {\r\n        ctx.container.removeEventListener('keydown', events.keydown);\r\n        ctx.container.removeEventListener('keyup', events.keyup);\r\n      }\r\n    },\r\n    trash: function(options) {\r\n      currentMode.trash(options);\r\n    },\r\n    combineFeatures: function() {\r\n      currentMode.combineFeatures();\r\n    },\r\n    uncombineFeatures: function() {\r\n      currentMode.uncombineFeatures();\r\n    },\r\n    getMode: function() {\r\n      return currentModeName;\r\n    }\r\n  };\r\n\r\n  return api;\r\n};\r\n"]},"metadata":{},"sourceType":"script"}