{"ast":null,"code":"const {\n  noTarget,\n  isOfMetaType,\n  isInactiveFeature,\n  isShiftDown\n} = require('../lib/common_selectors');\n\nconst createSupplementaryPoints = require('../lib/create_supplementary_points');\n\nconst constrainFeatureMovement = require('../lib/constrain_feature_movement');\n\nconst doubleClickZoom = require('../lib/double_click_zoom');\n\nconst Constants = require('../constants');\n\nconst CommonSelectors = require('../lib/common_selectors');\n\nconst moveFeatures = require('../lib/move_features');\n\nconst isVertex = isOfMetaType(Constants.meta.VERTEX);\nconst isMidpoint = isOfMetaType(Constants.meta.MIDPOINT);\nconst DirectSelect = {}; // INTERNAL FUCNTIONS\n\nDirectSelect.fireUpdate = function () {\n  this.map.fire(Constants.events.UPDATE, {\n    action: Constants.updateActions.CHANGE_COORDINATES,\n    features: this.getSelected().map(f => f.toGeoJSON())\n  });\n};\n\nDirectSelect.fireActionable = function (state) {\n  this.setActionableState({\n    combineFeatures: false,\n    uncombineFeatures: false,\n    trash: state.selectedCoordPaths.length > 0\n  });\n};\n\nDirectSelect.startDragging = function (state, e) {\n  this.map.dragPan.disable();\n  state.canDragMove = true;\n  state.dragMoveLocation = e.lngLat;\n};\n\nDirectSelect.stopDragging = function (state) {\n  this.map.dragPan.enable();\n  state.dragMoving = false;\n  state.canDragMove = false;\n  state.dragMoveLocation = null;\n};\n\nDirectSelect.onVertex = function (state, e) {\n  this.startDragging(state, e);\n  const about = e.featureTarget.properties;\n  const selectedIndex = state.selectedCoordPaths.indexOf(about.coord_path);\n\n  if (!isShiftDown(e) && selectedIndex === -1) {\n    state.selectedCoordPaths = [about.coord_path];\n  } else if (isShiftDown(e) && selectedIndex === -1) {\n    state.selectedCoordPaths.push(about.coord_path);\n  }\n\n  const selectedCoordinates = this.pathsToCoordinates(state.featureId, state.selectedCoordPaths);\n  this.setSelectedCoordinates(selectedCoordinates);\n};\n\nDirectSelect.onMidpoint = function (state, e) {\n  this.startDragging(state, e);\n  const about = e.featureTarget.properties;\n  state.feature.addCoordinate(about.coord_path, about.lng, about.lat);\n  this.fireUpdate();\n  state.selectedCoordPaths = [about.coord_path];\n};\n\nDirectSelect.pathsToCoordinates = function (featureId, paths) {\n  return paths.map(coord_path => {\n    return {\n      feature_id: featureId,\n      coord_path\n    };\n  });\n};\n\nDirectSelect.onFeature = function (state, e) {\n  if (state.selectedCoordPaths.length === 0) this.startDragging(state, e);else this.stopDragging(state);\n};\n\nDirectSelect.dragFeature = function (state, e, delta) {\n  moveFeatures(this.getSelected(), delta);\n  state.dragMoveLocation = e.lngLat;\n};\n\nDirectSelect.dragVertex = function (state, e, delta) {\n  const selectedCoords = state.selectedCoordPaths.map(coord_path => state.feature.getCoordinate(coord_path));\n  const selectedCoordPoints = selectedCoords.map(coords => ({\n    type: Constants.geojsonTypes.FEATURE,\n    properties: {},\n    geometry: {\n      type: Constants.geojsonTypes.POINT,\n      coordinates: coords\n    }\n  }));\n  const constrainedDelta = constrainFeatureMovement(selectedCoordPoints, delta);\n\n  for (let i = 0; i < selectedCoords.length; i++) {\n    const coord = selectedCoords[i];\n    state.feature.updateCoordinate(state.selectedCoordPaths[i], coord[0] + constrainedDelta.lng, coord[1] + constrainedDelta.lat);\n  }\n};\n\nDirectSelect.clickNoTarget = function () {\n  this.changeMode(Constants.modes.SIMPLE_SELECT);\n};\n\nDirectSelect.clickInactive = function () {\n  this.changeMode(Constants.modes.SIMPLE_SELECT);\n};\n\nDirectSelect.clickActiveFeature = function (state) {\n  state.selectedCoordPaths = [];\n  this.clearSelectedCoordinates();\n  state.feature.changed();\n}; // EXTERNAL FUNCTIONS\n\n\nDirectSelect.onSetup = function (opts) {\n  const featureId = opts.featureId;\n  const feature = this.getFeature(featureId);\n\n  if (!feature) {\n    throw new Error('You must provide a featureId to enter direct_select mode');\n  }\n\n  if (feature.type === Constants.geojsonTypes.POINT) {\n    throw new TypeError('direct_select mode doesn\\'t handle point features');\n  }\n\n  const state = {\n    featureId,\n    feature,\n    dragMoveLocation: opts.startPos || null,\n    dragMoving: false,\n    canDragMove: false,\n    selectedCoordPaths: opts.coordPath ? [opts.coordPath] : []\n  };\n  this.setSelectedCoordinates(this.pathsToCoordinates(featureId, state.selectedCoordPaths));\n  this.setSelected(featureId);\n  doubleClickZoom.disable(this);\n  this.setActionableState({\n    trash: true\n  });\n  return state;\n};\n\nDirectSelect.onStop = function () {\n  doubleClickZoom.enable(this);\n  this.clearSelectedCoordinates();\n};\n\nDirectSelect.toDisplayFeatures = function (state, geojson, push) {\n  if (state.featureId === geojson.properties.id) {\n    geojson.properties.active = Constants.activeStates.ACTIVE;\n    push(geojson);\n    createSupplementaryPoints(geojson, {\n      map: this.map,\n      midpoints: true,\n      selectedPaths: state.selectedCoordPaths\n    }).forEach(push);\n  } else {\n    geojson.properties.active = Constants.activeStates.INACTIVE;\n    push(geojson);\n  }\n\n  this.fireActionable(state);\n};\n\nDirectSelect.onTrash = function (state) {\n  state.selectedCoordPaths.sort().reverse().forEach(id => state.feature.removeCoordinate(id));\n  this.fireUpdate();\n  state.selectedCoordPaths = [];\n  this.clearSelectedCoordinates();\n  this.fireActionable(state);\n\n  if (state.feature.isValid() === false) {\n    this.deleteFeature([state.featureId]);\n    this.changeMode(Constants.modes.SIMPLE_SELECT, {});\n  }\n};\n\nDirectSelect.onMouseMove = function (state, e) {\n  // On mousemove that is not a drag, stop vertex movement.\n  const isFeature = CommonSelectors.isActiveFeature(e);\n  const onVertex = isVertex(e);\n  const noCoords = state.selectedCoordPaths.length === 0;\n  if (isFeature && noCoords) this.updateUIClasses({\n    mouse: Constants.cursors.MOVE\n  });else if (onVertex && !noCoords) this.updateUIClasses({\n    mouse: Constants.cursors.MOVE\n  });else this.updateUIClasses({\n    mouse: Constants.cursors.NONE\n  });\n  this.stopDragging(state);\n};\n\nDirectSelect.onMouseOut = function (state) {\n  // As soon as you mouse leaves the canvas, update the feature\n  if (state.dragMoving) this.fireUpdate();\n};\n\nDirectSelect.onTouchStart = DirectSelect.onMouseDown = function (state, e) {\n  if (isVertex(e)) return this.onVertex(state, e);\n  if (CommonSelectors.isActiveFeature(e)) return this.onFeature(state, e);\n  if (isMidpoint(e)) return this.onMidpoint(state, e);\n};\n\nDirectSelect.onDrag = function (state, e) {\n  if (state.canDragMove !== true) return;\n  state.dragMoving = true;\n  e.originalEvent.stopPropagation();\n  const delta = {\n    lng: e.lngLat.lng - state.dragMoveLocation.lng,\n    lat: e.lngLat.lat - state.dragMoveLocation.lat\n  };\n  if (state.selectedCoordPaths.length > 0) this.dragVertex(state, e, delta);else this.dragFeature(state, e, delta);\n  state.dragMoveLocation = e.lngLat;\n};\n\nDirectSelect.onClick = function (state, e) {\n  if (noTarget(e)) return this.clickNoTarget(state, e);\n  if (CommonSelectors.isActiveFeature(e)) return this.clickActiveFeature(state, e);\n  if (isInactiveFeature(e)) return this.clickInactive(state, e);\n  this.stopDragging(state);\n};\n\nDirectSelect.onTap = function (state, e) {\n  if (noTarget(e)) return this.clickNoTarget(state, e);\n  if (CommonSelectors.isActiveFeature(e)) return this.clickActiveFeature(state, e);\n  if (isInactiveFeature(e)) return this.clickInactive(state, e);\n};\n\nDirectSelect.onTouchEnd = DirectSelect.onMouseUp = function (state) {\n  if (state.dragMoving) {\n    this.fireUpdate();\n  }\n\n  this.stopDragging(state);\n};\n\nmodule.exports = DirectSelect;","map":{"version":3,"sources":["C:/Users/michele/Desktop/IT/Code/react/aboutmi/node_modules/@mapbox/mapbox-gl-draw/src/modes/direct_select.js"],"names":["noTarget","isOfMetaType","isInactiveFeature","isShiftDown","require","createSupplementaryPoints","constrainFeatureMovement","doubleClickZoom","Constants","CommonSelectors","moveFeatures","isVertex","meta","VERTEX","isMidpoint","MIDPOINT","DirectSelect","fireUpdate","map","fire","events","UPDATE","action","updateActions","CHANGE_COORDINATES","features","getSelected","f","toGeoJSON","fireActionable","state","setActionableState","combineFeatures","uncombineFeatures","trash","selectedCoordPaths","length","startDragging","e","dragPan","disable","canDragMove","dragMoveLocation","lngLat","stopDragging","enable","dragMoving","onVertex","about","featureTarget","properties","selectedIndex","indexOf","coord_path","push","selectedCoordinates","pathsToCoordinates","featureId","setSelectedCoordinates","onMidpoint","feature","addCoordinate","lng","lat","paths","feature_id","onFeature","dragFeature","delta","dragVertex","selectedCoords","getCoordinate","selectedCoordPoints","coords","type","geojsonTypes","FEATURE","geometry","POINT","coordinates","constrainedDelta","i","coord","updateCoordinate","clickNoTarget","changeMode","modes","SIMPLE_SELECT","clickInactive","clickActiveFeature","clearSelectedCoordinates","changed","onSetup","opts","getFeature","Error","TypeError","startPos","coordPath","setSelected","onStop","toDisplayFeatures","geojson","id","active","activeStates","ACTIVE","midpoints","selectedPaths","forEach","INACTIVE","onTrash","sort","reverse","removeCoordinate","isValid","deleteFeature","onMouseMove","isFeature","isActiveFeature","noCoords","updateUIClasses","mouse","cursors","MOVE","NONE","onMouseOut","onTouchStart","onMouseDown","onDrag","originalEvent","stopPropagation","onClick","onTap","onTouchEnd","onMouseUp","module","exports"],"mappings":"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","sourcesContent":["const {noTarget, isOfMetaType, isInactiveFeature, isShiftDown} = require('../lib/common_selectors');\r\nconst createSupplementaryPoints = require('../lib/create_supplementary_points');\r\nconst constrainFeatureMovement = require('../lib/constrain_feature_movement');\r\nconst doubleClickZoom = require('../lib/double_click_zoom');\r\nconst Constants = require('../constants');\r\nconst CommonSelectors = require('../lib/common_selectors');\r\nconst moveFeatures = require('../lib/move_features');\r\n\r\nconst isVertex = isOfMetaType(Constants.meta.VERTEX);\r\nconst isMidpoint = isOfMetaType(Constants.meta.MIDPOINT);\r\n\r\nconst DirectSelect = {};\r\n\r\n// INTERNAL FUCNTIONS\r\n\r\nDirectSelect.fireUpdate = function() {\r\n  this.map.fire(Constants.events.UPDATE, {\r\n    action: Constants.updateActions.CHANGE_COORDINATES,\r\n    features: this.getSelected().map(f => f.toGeoJSON())\r\n  });\r\n};\r\n\r\nDirectSelect.fireActionable = function(state) {\r\n  this.setActionableState({\r\n    combineFeatures: false,\r\n    uncombineFeatures: false,\r\n    trash: state.selectedCoordPaths.length > 0\r\n  });\r\n};\r\n\r\nDirectSelect.startDragging = function(state, e) {\r\n  this.map.dragPan.disable();\r\n  state.canDragMove = true;\r\n  state.dragMoveLocation = e.lngLat;\r\n};\r\n\r\nDirectSelect.stopDragging = function(state) {\r\n  this.map.dragPan.enable();\r\n  state.dragMoving = false;\r\n  state.canDragMove = false;\r\n  state.dragMoveLocation = null;\r\n};\r\n\r\nDirectSelect.onVertex = function (state, e) {\r\n  this.startDragging(state, e);\r\n  const about = e.featureTarget.properties;\r\n  const selectedIndex = state.selectedCoordPaths.indexOf(about.coord_path);\r\n  if (!isShiftDown(e) && selectedIndex === -1) {\r\n    state.selectedCoordPaths = [about.coord_path];\r\n  } else if (isShiftDown(e) && selectedIndex === -1) {\r\n    state.selectedCoordPaths.push(about.coord_path);\r\n  }\r\n\r\n  const selectedCoordinates = this.pathsToCoordinates(state.featureId, state.selectedCoordPaths);\r\n  this.setSelectedCoordinates(selectedCoordinates);\r\n};\r\n\r\nDirectSelect.onMidpoint = function(state, e) {\r\n  this.startDragging(state, e);\r\n  const about = e.featureTarget.properties;\r\n  state.feature.addCoordinate(about.coord_path, about.lng, about.lat);\r\n  this.fireUpdate();\r\n  state.selectedCoordPaths = [about.coord_path];\r\n};\r\n\r\nDirectSelect.pathsToCoordinates = function(featureId, paths) {\r\n  return paths.map(coord_path => { return { feature_id: featureId, coord_path }; });\r\n};\r\n\r\nDirectSelect.onFeature = function(state, e) {\r\n  if (state.selectedCoordPaths.length === 0) this.startDragging(state, e);\r\n  else this.stopDragging(state);\r\n};\r\n\r\nDirectSelect.dragFeature = function(state, e, delta) {\r\n  moveFeatures(this.getSelected(), delta);\r\n  state.dragMoveLocation = e.lngLat;\r\n};\r\n\r\nDirectSelect.dragVertex = function(state, e, delta) {\r\n  const selectedCoords = state.selectedCoordPaths.map(coord_path => state.feature.getCoordinate(coord_path));\r\n  const selectedCoordPoints = selectedCoords.map(coords => ({\r\n    type: Constants.geojsonTypes.FEATURE,\r\n    properties: {},\r\n    geometry: {\r\n      type: Constants.geojsonTypes.POINT,\r\n      coordinates: coords\r\n    }\r\n  }));\r\n\r\n  const constrainedDelta = constrainFeatureMovement(selectedCoordPoints, delta);\r\n  for (let i = 0; i < selectedCoords.length; i++) {\r\n    const coord = selectedCoords[i];\r\n    state.feature.updateCoordinate(state.selectedCoordPaths[i], coord[0] + constrainedDelta.lng, coord[1] + constrainedDelta.lat);\r\n  }\r\n};\r\n\r\nDirectSelect.clickNoTarget = function () {\r\n  this.changeMode(Constants.modes.SIMPLE_SELECT);\r\n};\r\n\r\nDirectSelect.clickInactive = function () {\r\n  this.changeMode(Constants.modes.SIMPLE_SELECT);\r\n};\r\n\r\nDirectSelect.clickActiveFeature = function (state) {\r\n  state.selectedCoordPaths = [];\r\n  this.clearSelectedCoordinates();\r\n  state.feature.changed();\r\n};\r\n\r\n// EXTERNAL FUNCTIONS\r\n\r\nDirectSelect.onSetup = function(opts) {\r\n  const featureId = opts.featureId;\r\n  const feature = this.getFeature(featureId);\r\n\r\n  if (!feature) {\r\n    throw new Error('You must provide a featureId to enter direct_select mode');\r\n  }\r\n\r\n  if (feature.type === Constants.geojsonTypes.POINT) {\r\n    throw new TypeError('direct_select mode doesn\\'t handle point features');\r\n  }\r\n\r\n  const state = {\r\n    featureId,\r\n    feature,\r\n    dragMoveLocation: opts.startPos || null,\r\n    dragMoving: false,\r\n    canDragMove: false,\r\n    selectedCoordPaths: opts.coordPath ? [opts.coordPath] : []\r\n  };\r\n\r\n  this.setSelectedCoordinates(this.pathsToCoordinates(featureId, state.selectedCoordPaths));\r\n  this.setSelected(featureId);\r\n  doubleClickZoom.disable(this);\r\n\r\n  this.setActionableState({\r\n    trash: true\r\n  });\r\n\r\n  return state;\r\n};\r\n\r\nDirectSelect.onStop = function() {\r\n  doubleClickZoom.enable(this);\r\n  this.clearSelectedCoordinates();\r\n};\r\n\r\nDirectSelect.toDisplayFeatures = function(state, geojson, push) {\r\n  if (state.featureId === geojson.properties.id) {\r\n    geojson.properties.active = Constants.activeStates.ACTIVE;\r\n    push(geojson);\r\n    createSupplementaryPoints(geojson, {\r\n      map: this.map,\r\n      midpoints: true,\r\n      selectedPaths: state.selectedCoordPaths\r\n    }).forEach(push);\r\n  } else {\r\n    geojson.properties.active = Constants.activeStates.INACTIVE;\r\n    push(geojson);\r\n  }\r\n  this.fireActionable(state);\r\n};\r\n\r\nDirectSelect.onTrash = function(state) {\r\n  state.selectedCoordPaths.sort().reverse().forEach(id => state.feature.removeCoordinate(id));\r\n  this.fireUpdate();\r\n  state.selectedCoordPaths = [];\r\n  this.clearSelectedCoordinates();\r\n  this.fireActionable(state);\r\n  if (state.feature.isValid() === false) {\r\n    this.deleteFeature([state.featureId]);\r\n    this.changeMode(Constants.modes.SIMPLE_SELECT, {});\r\n  }\r\n};\r\n\r\nDirectSelect.onMouseMove = function(state, e) {\r\n  // On mousemove that is not a drag, stop vertex movement.\r\n  const isFeature = CommonSelectors.isActiveFeature(e);\r\n  const onVertex = isVertex(e);\r\n  const noCoords = state.selectedCoordPaths.length === 0;\r\n  if (isFeature && noCoords) this.updateUIClasses({ mouse: Constants.cursors.MOVE });\r\n  else if (onVertex && !noCoords) this.updateUIClasses({ mouse: Constants.cursors.MOVE });\r\n  else this.updateUIClasses({ mouse: Constants.cursors.NONE });\r\n  this.stopDragging(state);\r\n};\r\n\r\nDirectSelect.onMouseOut = function(state) {\r\n  // As soon as you mouse leaves the canvas, update the feature\r\n  if (state.dragMoving) this.fireUpdate();\r\n};\r\n\r\nDirectSelect.onTouchStart = DirectSelect.onMouseDown = function(state, e) {\r\n  if (isVertex(e)) return this.onVertex(state, e);\r\n  if (CommonSelectors.isActiveFeature(e)) return this.onFeature(state, e);\r\n  if (isMidpoint(e)) return this.onMidpoint(state, e);\r\n};\r\n\r\nDirectSelect.onDrag = function(state, e) {\r\n  if (state.canDragMove !== true) return;\r\n  state.dragMoving = true;\r\n  e.originalEvent.stopPropagation();\r\n\r\n  const delta = {\r\n    lng: e.lngLat.lng - state.dragMoveLocation.lng,\r\n    lat: e.lngLat.lat - state.dragMoveLocation.lat\r\n  };\r\n  if (state.selectedCoordPaths.length > 0) this.dragVertex(state, e, delta);\r\n  else this.dragFeature(state, e, delta);\r\n\r\n  state.dragMoveLocation = e.lngLat;\r\n};\r\n\r\nDirectSelect.onClick = function(state, e) {\r\n  if (noTarget(e)) return this.clickNoTarget(state, e);\r\n  if (CommonSelectors.isActiveFeature(e)) return this.clickActiveFeature(state, e);\r\n  if (isInactiveFeature(e)) return this.clickInactive(state, e);\r\n  this.stopDragging(state);\r\n};\r\n\r\nDirectSelect.onTap = function(state, e) {\r\n  if (noTarget(e)) return this.clickNoTarget(state, e);\r\n  if (CommonSelectors.isActiveFeature(e)) return this.clickActiveFeature(state, e);\r\n  if (isInactiveFeature(e)) return this.clickInactive(state, e);\r\n};\r\n\r\nDirectSelect.onTouchEnd = DirectSelect.onMouseUp = function(state) {\r\n  if (state.dragMoving) {\r\n    this.fireUpdate();\r\n  }\r\n  this.stopDragging(state);\r\n};\r\n\r\nmodule.exports = DirectSelect;\r\n\r\n"]},"metadata":{},"sourceType":"script"}